<script>
    // 가장 기본적인 연결 및 이벤트 핸들러
    const socket = io();
    let chart;
    
    // 기본 로그 함수
    function log(msg) {
        console.log(msg);
        const debug = document.getElementById('debug');
        if (debug) {
            debug.innerHTML = `<div>${new Date().toLocaleTimeString()}: ${msg}</div>` + debug.innerHTML;
        }
    }
    
    // 연결 이벤트
    socket.on('connect', function() {
        log('서버 연결됨');
    });
    
    // 게임 시작 이벤트
    socket.on('start_game', function(data) {
        log(`게임 시작: ${JSON.stringify(data)}`);
        
        // 매우 단순한 애니메이션
        const startTime = Date.now();
        const duration = data.duration * 1000;
        const finalAngle = data.finalAngle;
        
        function doAnimation() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(1.0, elapsed / duration);
            const angle = finalAngle * progress;
            
            // 회전 적용
            document.getElementById('rotating-container').style.transform = `rotate(${angle}deg)`;
            
            // 종료 조건
            if (progress < 1.0) {
                requestAnimationFrame(doAnimation);
            }
        }
        
        // 애니메이션 시작
        doAnimation();
    });
    
    // 당첨자 이벤트
    socket.on('update_winner', function(data) {
        log(`당첨자: ${data.winner}`);
        document.getElementById('winner').innerHTML = `당첨자: ${data.winner}님`;
        document.getElementById('start-button').disabled = false;
    });
    
    // 시작 버튼
    document.getElementById('start-button').addEventListener('click', function() {
        this.disabled = true;
        log('시작 버튼 클릭됨');
        
        const timeInput = document.getElementById('target-time').value;
        if (!timeInput) {
            alert('시간을 입력해주세요');
            this.disabled = false;
            return;
        }
        
        // 로컬 시간 변환
        const [hours, minutes] = timeInput.split(':').map(Number);
        const now = new Date();
        now.setHours(hours, minutes, 0, 0);
        
        // UTC 시간 변환
        const utcTime = `${String(now.getUTCHours()).padStart(2, '0')}:${String(now.getUTCMinutes()).padStart(2, '0')}:00`;
        
        log(`서버에 시간 전송: ${utcTime}`);
        socket.emit('start_rotation', { time: utcTime });
    });
    
    // 초기화 버튼
    document.getElementById('reset-button').addEventListener('click', function() {
        log('초기화 버튼 클릭됨');
        socket.emit('reset_game');
        document.getElementById('start-button').disabled = false;
        document.getElementById('winner').innerHTML = '';
        document.getElementById('rotating-container').style.transform = 'rotate(0deg)';
    });
    
    // 차트 초기화
    function initChart() {
        Chart.register(ChartDataLabels);
        const ctx = document.getElementById('dart-chart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [{% for p in participants %}'{{ p[0] }}',{% endfor %}],
                datasets: [{
                    data: [{% for p in participants %}{{ p[1] }},{% endfor %}],
                    backgroundColor: [{% for color in colors %}'{{ color }}',{% endfor %}]
                }]
            },
            options: {
                rotation: -Math.PI / 2,
                animation: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    datalabels: {
                        color: '#000',
                        formatter: function(value, context) {
                            return context.chart.data.labels[context.dataIndex];
                        },
                        font: { size: 14 }
                    }
                },
                cutout: '60%'
            }
        });
        log('차트 초기화 완료');
    }
    
    // 페이지 로드 시
    window.onload = function() {
        initChart();
        setInterval(function() {
            document.getElementById('current-time').innerText = 
                new Date().toLocaleTimeString('ko-KR', { hour12: false });
        }, 1000);
        
        log('페이지 로드 완료');
    };
</script>
