<!-- 스크립트 내용을 다음으로 교체하세요 -->
<script>
    // 디버그 로그 함수
    function log(message) {
        console.log(message);
        const debugEl = document.getElementById('debug');
        if (debugEl) {
            const time = new Date().toLocaleTimeString();
            debugEl.innerHTML = `<div>[${time}] ${message}</div>` + debugEl.innerHTML;
        }
    }

    // 전역 변수
    let chart;
    let currentAudio = null;
    let socket;

    // 차트 초기화
    function initChart() {
        try {
            Chart.register(ChartDataLabels);
            const ctx = document.getElementById('dart-chart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [{% for p in participants %}'{{ p[0] }}',{% endfor %}],
                    datasets: [{
                        data: [{% for p in participants %}{{ p[1] }},{% endfor %}],
                        backgroundColor: [{% for color in colors %}'{{ color }}',{% endfor %}]
                    }]
                },
                options: {
                    rotation: -Math.PI / 2,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: {
                            color: '#000',
                            formatter: function(value, context) {
                                return context.chart.data.labels[context.dataIndex];
                            },
                            font: { size: 14 }
                        }
                    },
                    cutout: '60%'
                }
            });
            log("차트 초기화 완료");
        } catch (e) {
            log("차트 초기화 오류: " + e);
        }
    }

    // 사운드 재생 함수
    function playSound(url) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
        currentAudio = new Audio(url);
        currentAudio.play().catch(e => log("오디오 오류: " + e));
    }

    // 시간 업데이트
    function updateTime() {
        const timeEl = document.getElementById('current-time');
        if (timeEl) {
            timeEl.innerText = new Date().toLocaleTimeString('ko-KR', { hour12: false });
        }
    }

    // 시작 버튼 이벤트
    function handleStartClick() {
        log("시작 버튼 클릭");
        const startBtn = document.getElementById('start-button');
        if (startBtn) startBtn.disabled = true;
        
        const timeInput = document.getElementById('target-time').value;
        if (!timeInput) {
            alert('시간을 입력해주세요.');
            if (startBtn) startBtn.disabled = false;
            return;
        }
        
        // UTC 시간 변환
        const [hours, minutes] = timeInput.split(':').map(Number);
        const localDate = new Date();
        localDate.setHours(hours, minutes, 0, 0);
        const utcMs = localDate.getTime() + (localDate.getTimezoneOffset() * 60000);
        const utcDate = new Date(utcMs);
        
        const utcHours = utcDate.getHours().toString().padStart(2, '0');
        const utcMins = utcDate.getMinutes().toString().padStart(2, '0');
        const utcSecs = utcDate.getSeconds().toString().padStart(2, '0');
        const formattedTime = `${utcHours}:${utcMins}:${utcSecs}`;
        
        log("시작 요청 전송: " + formattedTime);
        socket.emit('start_rotation', { time: formattedTime });
    }

    // 초기화 버튼 이벤트
    function handleResetClick() {
        log("초기화 버튼 클릭");
        socket.emit('reset_game');
    }

    // 페이지 로드 완료 시 실행
    window.onload = function() {
        log("페이지 로드됨");
        
        // Socket.IO 연결
        try {
            socket = io();
            log("Socket.IO 연결 성공");
            
            // 이벤트 리스너 설정
            socket.on('connect', function() {
                log("서버에 연결됨");
            });
            
            socket.on('disconnect', function() {
                log("서버 연결 끊김");
            });
            
            socket.on('game_reset_complete', function() {
                log("게임 초기화 완료");
                const startBtn = document.getElementById('start-button');
                if (startBtn) startBtn.disabled = false;
                
                const winnerEl = document.getElementById('winner');
                if (winnerEl) winnerEl.innerText = '';
                
                const rotatingEl = document.getElementById('rotating-container');
                if (rotatingEl) rotatingEl.style.transform = 'rotate(0deg)';
            });
            
            socket.on('start_game', function(data) {
                log(`게임 시작: 지속=${data.duration}초, 각도=${data.finalAngle}, 당첨자=${data.winner}`);
                
                const startBtn = document.getElementById('start-button');
                if (startBtn) startBtn.disabled = true;
                
                // 간단한 애니메이션
                const startTime = Date.now();
                const duration = data.duration * 1000;
                const finalAngle = data.finalAngle;
                
                function doAnimation() {
                    const now = Date.now();
                    const elapsed = now - startTime;
                    const progress = Math.min(1.0, elapsed / duration);
                    
                    // 단순 선형 보간
                    const angle = finalAngle * progress;
                    
                    const rotatingEl = document.getElementById('rotating-container');
                    if (rotatingEl) {
                        rotatingEl.style.transform = `rotate(${angle}deg)`;
                        log(`애니메이션: ${Math.round(angle)}° (${Math.round(progress*100)}%)`);
                    }
                    
                    if (progress < 1.0) {
                        requestAnimationFrame(doAnimation);
                    }
                }
                
                doAnimation();
            });
            
            socket.on('update_winner', function(data) {
                log("당첨자: " + data.winner);
                const winnerEl = document.getElementById('winner');
                if (winnerEl) winnerEl.innerText = '당첨자: ' + data.winner + '님';
                
                const startBtn = document.getElementById('start-button');
                if (startBtn) startBtn.disabled = false;
            });
            
            socket.on('error', function(data) {
                log("오류: " + data.message);
                alert(data.message);
                
                const startBtn = document.getElementById('start-button');
                if (startBtn) startBtn.disabled = false;
            });
            
            socket.on('play_beep', function() {
                log("비프음 재생");
                playSound('/static/beep.wav');
            });
            
            socket.on('play_fanfare', function() {
                log("팡파레 재생");
                playSound('/static/fanfare.wav');
            });
            
        } catch (e) {
            log("Socket.IO 오류: " + e);
        }
        
        // 버튼 이벤트 리스너 설정
        const startBtn = document.getElementById('start-button');
        if (startBtn) {
            startBtn.onclick = handleStartClick;
            log("시작 버튼 이벤트 설정됨");
        } else {
            log("오류: 시작 버튼을 찾을 수 없음");
        }
        
        const resetBtn = document.getElementById('reset-button');
        if (resetBtn) {
            resetBtn.onclick = handleResetClick;
            log("초기화 버튼 이벤트 설정됨");
        } else {
            log("오류: 초기화 버튼을 찾을 수 없음");
        }
        
        // 차트 초기화 및 시간 업데이트
        initChart();
        updateTime();
        setInterval(updateTime, 1000);
        
        // 디버그 영역 표시
        const debugEl = document.getElementById('debug');
        if (debugEl) debugEl.style.display = 'block';
    };
</script>
